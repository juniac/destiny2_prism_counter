<!DOCTYPE html>
<html class="no-js css-menubar" lang="ko">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta name="description" content="bootstrap admin template">
  <meta name="author" content="maneuling">
  <title>Sandbox | maneuling</title>
  <script
    src="http://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
        crossorigin="anonymous"></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">  
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js" integrity="sha384-feJI7QwhOS+hwpX2zkaeJQjeiwlhOP+SdQDqhgvvo1DsjtiSQByFdThsxO669S2D" crossorigin="anonymous"></script>

</head>
<body class="page-login layout-full bg-blue-grey-800">
  <!--[if lt IE 8]>
        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
  <!-- Page -->


  <div class="page text-center" >
    <div class="page-content ">
      <h3 class="blue-grey-300">Prism Modifier Tracker</h3>
      <div class="panel panel-bordered panel-success">
            <div id="damage_type_title_bg" class="panel-heading bg-grey-500 padding-3">
              <h1 class="white font-weight-300" id="damage_type_title"><strong></strong></h1>
            </div>
            <div class="panel-body height-200 padding-0">
              <div  style="position:absolute;width:100%;height:100%" class="padding-top-30">
                <span id="time_remaining" class="font-size-80 font-weight-600 text-center black text-middle">대기중</span>
              </div>

              <div style="height:100%;width:100%;" id="time_remaining_background">
                <div style="background-color: #FFFFFF;height:30%;width:100%;" id="percentage">

                </div>


              </div>




            </div>
              <div class="panel-body padding-10 blue-grey-700 font-weight-600" id="next">

              </div>


              <div class="panel-footer bg-grey-300" id="damage_type_button_wrapper">
                <button type="button" class="btn bg-orange-700 white btn-lg height-100 width-100" id="solar" >솔라</button>
                <button type="button" class="btn bg-purple-600 white btn-lg height-100 width-100" id="void" >보이드</button>
                <button type="button" class="btn bg-blue-600 white btn-lg height-100 width-100" id="arc" >아크</button>
              <br/>


                <button id="stop" type="button" class="btn margin-top-10 height-60 width-300 bg-grey-400 white">정지</button>
                <input type="hidden" id="timevalue" value="30" />
              </div>
          </div>


    </div>
  </div>



</body>

  <script>
  $(function() {

    var colors = {
      solar:{
        primary:'bg-orange-700',
        secondary:'bg-orange-400'
      },
      void:{
          primary:'bg-purple-600',
          secondary:'bg-purple-400'
      },
      arc:{
        primary:'bg-blue-600',
        secondary:'bg-blue-400'
      },
      stop:{
        primary:'bg-grey-500',
        secondary:'bg-grey-300'
      }
    };

    var currentDamageTypeTitle = $("#damage_type_title");
    var currentDamageTypeTitleWrapper = $("#damage_type_title_bg");
    var timeRemaning = $("#time_remaining");
    var percentage = $("#percentage");
    var timeRemaningBackground = $("#time_remaining_background");
    var nextUpcoming = $("#next");

    var damageTypeButtons = $('#damage_type_button_wrapper').children();




    var remain = parseInt($('#timevalue').val());
    var currentDamageTypeIndex = 1;
    var timer = null;
    var interval = 1000;
    var timePassed = 0;
    var loopInterval = parseInt($('#timevalue').val());

    var button = {
      solar:$("#solar"),
      arc:$("#arc"),
      voi:$("#void"),
      stop:$("#stop")
    };

    var init = function() {
      button.solar.on('click', start);
      button.voi.on('click', start);
      button.arc.on('click', start);
      button.stop.on('click', stop);
    }



    var start = function() {

      var selectedDamageTypeIndex = damageTypeButtons.index($(this));

      clearTimeout(timer);
      currentDamageTypeIndex = selectedDamageTypeIndex;
      timePassed = 1000;
      loopInterval = parseInt($('#timevalue').val()) * 1000;
      remain = loopInterval - timePassed;
      changeState(selectedDamageTypeIndex);
      if (timer != null) {
        timer.stop();
        timer = null;
      }
      loop();
      timer = new adjustingInterval(loop, interval, function(){});
      timer.start();
    };

    var stop = function() {
      //clearTimeout(timer);
      if (timer != null) {
        timer.stop();
        timer = null;
      }
      changeState(-999);
    };



    var loop = function() {

      // console.log(timePassed);
      timeRemaning.text(Math.ceil(remain / 1000));
      var remainPercentage = 100 - (remain / loopInterval * 100);
      percentage.css('height', remainPercentage + "%");


      if (remain < 0) {
        //var time = parseInt($('#timevalue').val());
        remain = loopInterval;
        currentDamageTypeIndex++;
        if (currentDamageTypeIndex > 2) {
          currentDamageTypeIndex = 0;
        }
        timeRemaning.text(Math.ceil(remain / 1000));
        changeState(currentDamageTypeIndex);
      }


      remain = remain - interval;

      timePassed = timePassed + interval;
      //timer = setTimeout(loop, interval)





    };

    var changeState = function(index) {
      var damageType = null;
      if (index >= 0) {
        damageType = $(damageTypeButtons[index]).attr('id');
      }

      clear();



      var properties = {
        title:"",
        titleClassName:"",
        nextUpcomingClass:"",
        nextUpcommingDamage:"",
      };

      switch (damageType) {
        case 'solar':
            properties.title = '솔라';
            properties.titleClassName = colors.solar.primary;
            properties.nextUpcommingDamage = '다음 속성 보이드';
            properties.nextUpcomingClass = colors.void.secondary;
          break;
        case 'void':
            properties.title = '보이드';
            properties.titleClassName = colors.void.primary;
            properties.nextUpcommingDamage = '다음 속성 아크';
            properties.nextUpcomingClass = colors.arc.secondary;
          break;
        case 'arc':
            properties.title = '아크';
            properties.titleClassName = colors.arc.primary;
            properties.nextUpcommingDamage = '다음 속성 솔라';
            properties.nextUpcomingClass = colors.solar.secondary;
          break;

        default:
          properties.title = '';
          properties.titleClassName = colors.stop.primary;
          properties.nextUpcommingDamage = '';
          //properties.nextUpcomingClass = colors.stop.secondary;
          break;

      }
      currentDamageTypeTitle.text(properties.title);
      currentDamageTypeTitleWrapper.addClass(properties.titleClassName);

      nextUpcoming.addClass(properties.nextUpcomingClass);
      nextUpcoming.text(properties.nextUpcommingDamage);
      if (index >= 0) {
        timeRemaningBackground.addClass(properties.titleClassName);
      } else {
        timeRemaning.text('대기중');
      }
    };

    var clear = function() {

      percentage.css('height', '0%');
      $.each(colors, function(key, item) {
          currentDamageTypeTitleWrapper.removeClass(item.primary);
          timeRemaningBackground.removeClass(item.primary);
          nextUpcoming.removeClass(item.secondary);
      });

      currentDamageTypeTitleWrapper.removeClass('bg-grey-500');
    }

    var adjustingInterval = function(workFunc, interval, errorFunc) {
      var that = this;
      var expected, timeout;
      this.interval = interval;

      this.start = function() {
          expected = Date.now() + this.interval;
          timeout = setTimeout(step, this.interval);
      }

      this.stop = function() {
          clearTimeout(timeout);
      }

      function step() {
          var drift = Date.now() - expected;
          if (drift > that.interval) {
              // You could have some default stuff here too...
              if (errorFunc) errorFunc();
          }
          workFunc();
          expected += that.interval;
          timeout = setTimeout(step, Math.max(0, that.interval-drift));
      }
    };

    init();

  });
  </script>


</html>




